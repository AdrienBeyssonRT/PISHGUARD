// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Organization {
  id            Int       @id @default(autoincrement())
  name          String
  domain        String?
  plan          Plan      @default(FREE)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  users         User[]
  employees     Employee[]
  templates     Template[]
  campaigns     Campaign[]
  detectionEvents DetectionEvent[]
  subscriptions Subscription[]
  auditLogs     AuditLog[]

  @@map("organizations")
}

model User {
  id             Int       @id @default(autoincrement())
  email          String    @unique
  passwordHash   String
  role           UserRole  @default(OWNER)
  firstName      String?
  lastName       String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId Int

  auditLogs      AuditLog[]

  @@map("users")
}

model Employee {
  id             Int          @id @default(autoincrement())
  email          String
  firstName      String?
  lastName       String?
  team           String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId Int

  simulations    SimulationEmail[]

  @@map("employees")
}

model Template {
  id             Int          @id @default(autoincrement())
  name           String
  subject        String
  htmlBody       String
  isGlobal       Boolean      @default(false)

  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId Int?

  campaigns      Campaign[]

  @@map("templates")
}

model Campaign {
  id             Int          @id @default(autoincrement())
  name           String
  status         CampaignStatus @default(DRAFT)
  startAt        DateTime?
  endAt          DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId Int

  template       Template     @relation(fields: [templateId], references: [id])
  templateId     Int

  simulationEmails SimulationEmail[]

  @@map("campaigns")
}

model SimulationEmail {
  id              Int       @id @default(autoincrement())
  sentAt          DateTime?
  openedAt        DateTime?
  clickedAt       DateTime?
  submittedAt     DateTime?
  createdAt       DateTime  @default(now())

  campaign        Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campaignId      Int

  employee        Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId      Int

  @@map("simulation_emails")
}

model DetectionEvent {
  id             Int          @id @default(autoincrement())
  recipientEmail String
  subject        String
  score          Int
  verdict        Verdict
  createdAt      DateTime     @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId Int

  rawHeaders     String?      @db.Text
  summary        String?      @db.Text

  @@map("detection_events")
}

model Subscription {
  id             Int          @id @default(autoincrement())
  stripeCustomerId String
  stripePriceId  String
  status         SubscriptionStatus
  currentPeriodEnd DateTime

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId Int

  @@map("subscriptions")
}

model AuditLog {
  id             Int          @id @default(autoincrement())
  action         String
  metadata       Json?
  createdAt      DateTime     @default(now())

  user           User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId         Int?

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId Int

  @@map("audit_logs")
}

enum UserRole {
  OWNER
  ADMIN
  EMPLOYEE
}

enum Plan {
  FREE
  BASIC
  PRO
  ENTERPRISE
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  RUNNING
  FINISHED
}

enum Verdict {
  SAFE
  SUSPICIOUS
  PHISHING
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
}

